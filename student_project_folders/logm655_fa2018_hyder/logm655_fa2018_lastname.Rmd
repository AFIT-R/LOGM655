---
title: "LOGM 655 Student Project Report"
author: "Dylan Hyder"
date: "`r format(Sys.Date(), '%d %b %Y')`"
output: 
    html_document:
    code_folding: 'hide'
abstract: 'This is where you put your abstract'
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = F,
                      warning = F, 
                      comment = NA)
```


## Project Overview/Problem Statement 

Describe your project in sufficient detail for someone who is not familiar with text mining or NLP can understand what you are saying. This section should conclude with a problem statement that clearly and concisely describes the problem you are addressing (aka the question you are trying to answer).

Problem Statement: Named Entity recognition of fairy tales 

## Installing Loading Required R Packages

The following packages will be used in this document; they are necessary to follow along with the methodology and  reproduce the results from this research. The *pacman* package is used to facilitate installing and loading necessary packages. If you do not have the *pacman* package installed and loaded you should do that before proceeding.

```{r InstallPackages, warning=FALSE, message=FALSE}
pacman::p_load(XML,        
               rvest,      
               RCurl,      
               rprojroot,  
               tidytext,   
               stringr,
               pdftools,
               tidyr,
               dplyr,
               yaml,
               ggplot2,
               gutenbergr,
               xts)
```

## Methodology

Describe the steps and methods you used for your analysis to go from raw data to end result. 

### Data

Describe the data

- Where did you get the data?
- In what format was the data when you received/retreived it?
- What transformations did you perform on the data?
Upload the data from the gutenbergr package.

```{r InputData_gutenbergR, warning=FALSE, message=FALSE}
grimm <- gutenberg_download(2591)
```

With the uploaded data we need to create a corpus from the data, seperating each fairy tale as a seperate document. The first step in doing this is to determine all the titles of the fairy tales and to determine when each begins. We can figure this out with **regex**. If you notice, in the pdf of this text, all the titles are capitalized and on their own line. Drawing upon this pattern we can use **regex** to search when this occurs and we can create a new column that has an *NA* if that line in the text is not a title and contains the story title if that line is the title to a fairy tale. Then we can append a 3rd column that fills all the *NA* values with the previous non-NA value. This in essence fills in a column to indicate what fairy tale each line in the text is from.
```{r} 
grimm_stories <- grimm[-c(1:93), , drop = FALSE] %>%
  mutate(story_title = ifelse(str_detect(text, regex("^[12\\,\\.\\[\\]A-Z \\'\\-]+$")), text, NA),
         story = na.locf(story_title)) 

grimm_stories
```

After doing this for the dataset of all Brothers Grimm fairy tales we can subset the corpus to include only certain fairy tales we want by searching by fairy tale title. This example shows how we can pull out the story *The Fox and the Cat*. This can be useful when doing analysis because it is hard to visualize and display results of the 68 (need to check number) fairy tales that are in the corpus.
```{r}
grimm_TheFoxAndTheCat <- grimm_stories %>% 
  filter(story %in% c("THE FOX AND THE CAT")) %>%
  mutate(linenumber = row_number()) %>% 
  select(text, linenumber, story) 

grimm_TheFoxAndTheCat
``` 

After formatting the data to identify what fairy tale each line is from we should structure the data as a tidy tibble. In this format each observation/ line is a word and there is another column indicating which story that word is associated with.
```{r}
tidy_stories <- grimm_stories%>%
  unnest_tokens(word, text)
```

With a tidy dataset created we are ready to conduct preliminary analysis. First lets seperate fairy tales into categories based on the Aarne-Thompson-Uther Classification of Folk Tales. (http://www.mftd.org/index.php?action=atu) (https://www.grimmstories.com/en/grimm_fairy-tales/classification)
The broad categories that are being used are 

Animal Tales: 1-299
Tales of Magic: 300-749
Religious Tales: 750-849
Realistic Tales: 850-999
Tales of the Stupid Ogre: 1000-1199
Anecdotes and Jokes: 1200-1999
Formula Tales: 2000-2399

### Subset Fairy Tales into Categories
There are 9 fairy tales classified as animal tales.
```{r}
AnimalTales <- grimm_stories %>% 
  filter(story %in% c("OLD SULTAN", 
                      "THE STRAW, THE COAL, AND THE BEAN",
                      "THE DOG AND THE SPARROW",
                      "THE WILLOW-WREN AND THE BEAR",
                      "CAT AND MOUSE IN PARTNERSHIP",
                      "THE MOUSE, THE BIRD, AND THE SAUSAGE",
                      "THE WOLF AND THE SEVEN LITTLE KIDS",
                      "THE FOX AND THE CAT",
                      "THE FOX AND THE HORSE"
                      )) %>%
  mutate(linenumber = row_number()) %>% 
  select(text, linenumber, story) 

AnimalTales
```

```{r}
TalesOfMagic <- grimm_stories %>% 
  filter(story %in% c("JORINDA AND JORINDEL",
                      "BRIAR ROSE",
                      "THE TWELVE DANCING PRINCESSES",
                      "THE FISHERMAN AND HIS WIFE",
                      "THE FROG-PRINCE",
                      "THE GOOSE-GIRL",
                      "RAPUNZEL",
                      "FUNDEVOGEL",
                      "HANSEL AND GRETEL",
                      "LITTLE RED-CAP [LITTLE RED RIDING HOOD]",
                      "TOM THUMB",
                      "RUMPELSTILTSKIN",
                      "THE PINK",
                      "THE WHITE SNAKE",
                      "THE QUEEN BEE",
                      "THE JUNIPER-TREE",
                      "THE THREE LANGUAGES",
                      "THE BLUE LIGHT",
                      "THE RAVEN",
                      "THE GOLDEN GOOSE",
                      "THE WATER OF LIFE",
                      "THE KING OF THE GOLDEN MOUNTAIN",
                      "THE SEVEN RAVENS",
                      "THE STORY OF THE YOUTH WHO WENT FORTH TO LEARN WHAT FEAR WAS",
                      "SNOW-WHITE AND ROSE-RED"
                      )) %>%
  mutate(linenumber = row_number()) %>% 
  select(text, linenumber, story) 

TalesOfMagic
```

```{r}
RealisticTales <- grimm_stories %>% 
  filter(story %in% c("THE ROBBER BRIDEGROOM",
                      "THE OLD MAN AND HIS GRANDSON",
                      "THE TWELVE HUNTSMEN"
                      )) %>%
  mutate(linenumber = row_number()) %>% 
  select(text, linenumber, story) 

RealisticTales
```

```{r}
AnecdotesAndJokes <- grimm_stories %>% 
  filter(story %in% c("HANS IN LUCK",
                      "THE VALIANT LITTLE TAILOR",
                      "CLEVER GRETEL",
                      "THE LITTLE PEASANT",
                      "FREDERICK AND CATHERINE",
                      "CLEVER ELSIE",
                      "CLEVER HANS",
                      "THE FOUR CLEVER BROTHERS",
                      "DOCTOR KNOWALL"
                      )) %>%
  mutate(linenumber = row_number()) %>% 
  select(text, linenumber, story) 

AnecdotesAndJokes
```

```{r}
FormulaTales <- grimm_stories %>% 
  filter(story %in% c("THE TURNIP"
                      )) %>%
  mutate(linenumber = row_number()) %>% 
  select(text, linenumber, story) 

FormulaTales
```

```{r}
NoCategoryTales <- grimm_stories %>% 
  filter(story %in% c("THE TRAVELLING MUSICIANS",
                      "THE ADVENTURES OF CHANTICLEER AND PARTLET",
                      "1. HOW THEY WENT TO THE MOUNTAINS TO EAT NUTS",
                      "2. HOW CHANTICLEER AND PARTLET WENT TO VISIT MR KORBES",
                      "MOTHER HOLLE",
                      "SWEETHEART ROLAND",
                      "SNOWDROP",
                      "THE MISER IN THE BUSH",
                      "ASHPUTTEL",
                      "THE ELVES AND THE SHOEMAKER",
                      "LILY AND THE LION",
                      "THE WEDDING OF MRS FOX",
                      "FIRST STORY",
                      "SECOND STORY",
                      "THE SALAD",
                      "KING GRISLY-BEARD",
                      "IRON HANS",
                      "CAT-SKIN"
                      )) %>%
  mutate(linenumber = row_number()) %>% 
  select(text, linenumber, story) 

NoCategoryTales
```

### Word Frequency on Fairy Tales by Category
```{r}
AnimalTales %>%
  unnest_tokens(word, text)%>%
  anti_join(stop_words)%>%
  group_by(story)%>%
  count(word)%>%
  arrange(story, desc(n))%>%
  top_n(8)%>%
  ungroup()%>%
  mutate(word = reorder(word, n))%>%
  ggplot(aes(word, n, fill=story))+
  geom_col(show.legend = FALSE)+
  xlab(NULL)+
  coord_flip()+
  facet_wrap(~story, ncol=3, scales="free" )

```

```{r}
TalesOfMagic %>%
  unnest_tokens(word, text)%>%
  anti_join(stop_words)%>%
  group_by(story)%>%
  count(word)%>%
  arrange(story, desc(n))%>%
  top_n(8)%>%
  ungroup()%>%
  mutate(word = reorder(word, n))%>%
  ggplot(aes(word, n, fill=story))+
  geom_col(show.legend = FALSE)+
  xlab(NULL)+
  coord_flip()+
  facet_wrap(~story, ncol=5, scales="free" )

```

```{r}
RealisticTales %>%
  unnest_tokens(word, text)%>%
  anti_join(stop_words)%>%
  group_by(story)%>%
  count(word)%>%
  arrange(story, desc(n))%>%
  top_n(8)%>%
  ungroup()%>%
  mutate(word = reorder(word, n))%>%
  ggplot(aes(word, n, fill=story))+
  geom_col(show.legend = FALSE)+
  xlab(NULL)+
  coord_flip()+
  facet_wrap(~story, ncol=3, scales="free" )

```

```{r}
AnecdotesAndJokes %>%
  unnest_tokens(word, text)%>%
  anti_join(stop_words)%>%
  group_by(story)%>%
  count(word)%>%
  arrange(story, desc(n))%>%
  top_n(8)%>%
  ungroup()%>%
  mutate(word = reorder(word, n))%>%
  ggplot(aes(word, n, fill=story))+
  geom_col(show.legend = FALSE)+
  xlab(NULL)+
  coord_flip()+
  facet_wrap(~story, ncol=3, scales="free" )

```

```{r}
FormulaTales %>%
  unnest_tokens(word, text)%>%
  anti_join(stop_words)%>%
  group_by(story)%>%
  count(word)%>%
  arrange(story, desc(n))%>%
  top_n(8)%>%
  ungroup()%>%
  mutate(word = reorder(word, n))%>%
  ggplot(aes(word, n, fill=story))+
  geom_col(show.legend = FALSE)+
  xlab(NULL)+
  coord_flip()+
  facet_wrap(~story, ncol=3, scales="free" )

```

```{r}
NoCategoryTales %>%
  unnest_tokens(word, text)%>%
  anti_join(stop_words)%>%
  group_by(story)%>%
  count(word)%>%
  arrange(story, desc(n))%>%
  top_n(8)%>%
  ungroup()%>%
  mutate(word = reorder(word, n))%>%
  ggplot(aes(word, n, fill=story))+
  geom_col(show.legend = FALSE)+
  xlab(NULL)+
  coord_flip()+
  facet_wrap(~story, ncol=3, scales="free" )

```

### Sentiment Analysis with BING by Category
```{r}
AnimalTales_sentiment_bing <- AnimalTales %>%
  unnest_tokens(word, text) %>%
  inner_join(get_sentiments("bing")) %>%
  count(story, index=linenumber%/%5, sentiment)%>%
  spread(sentiment, n, fill = 0)%>%
  mutate(sentiment = positive - negative)

AnimalTales_sentiment_bing%>%
  ggplot(aes(index, sentiment, fill=story))+
  geom_col(show.legend = FALSE)+
  facet_wrap(~story, ncol = 2, scales = "free_x")
```

```{r}
TalesOfMagic_sentiment_bing <- TalesOfMagic %>%
  unnest_tokens(word, text) %>%
  inner_join(get_sentiments("bing")) %>%
  count(story, index=linenumber%/%5, sentiment)%>%
  spread(sentiment, n, fill = 0)%>%
  mutate(sentiment = positive - negative)

TalesOfMagic_sentiment_bing%>%
  ggplot(aes(index, sentiment, fill=story))+
  geom_col(show.legend = FALSE)+
  facet_wrap(~story, ncol = 2, scales = "free_x")
```

```{r}
RealisticTales_sentiment_bing <- RealisticTales %>%
  unnest_tokens(word, text) %>%
  inner_join(get_sentiments("bing")) %>%
  count(story, index=linenumber%/%5, sentiment)%>%
  spread(sentiment, n, fill = 0)%>%
  mutate(sentiment = positive - negative)

RealisticTales_sentiment_bing%>%
  ggplot(aes(index, sentiment, fill=story))+
  geom_col(show.legend = FALSE)+
  facet_wrap(~story, ncol = 2, scales = "free_x")
```

```{r}
AnecdotesAndJokes_sentiment_bing <- AnecdotesAndJokes %>%
  unnest_tokens(word, text) %>%
  inner_join(get_sentiments("bing")) %>%
  count(story, index=linenumber%/%5, sentiment)%>%
  spread(sentiment, n, fill = 0)%>%
  mutate(sentiment = positive - negative)

AnecdotesAndJokes_sentiment_bing%>%
  ggplot(aes(index, sentiment, fill=story))+
  geom_col(show.legend = FALSE)+
  facet_wrap(~story, ncol = 2, scales = "free_x")
```

```{r}
FormulaTales_sentiment_bing <- FormulaTales %>%
  unnest_tokens(word, text) %>%
  inner_join(get_sentiments("bing")) %>%
  count(story, index=linenumber%/%5, sentiment)%>%
  spread(sentiment, n, fill = 0)%>%
  mutate(sentiment = positive - negative)

FormulaTales_sentiment_bing%>%
  ggplot(aes(index, sentiment, fill=story))+
  geom_col(show.legend = FALSE)+
  facet_wrap(~story, ncol = 2, scales = "free_x")
```

```{r}
NoCategoryTales_sentiment_bing <- NoCategoryTales %>%
  unnest_tokens(word, text) %>%
  inner_join(get_sentiments("bing")) %>%
  count(story, index=linenumber%/%5, sentiment)%>%
  spread(sentiment, n, fill = 0)%>%
  mutate(sentiment = positive - negative)

NoCategoryTales_sentiment_bing%>%
  ggplot(aes(index, sentiment, fill=story))+
  geom_col(show.legend = FALSE)+
  facet_wrap(~story, ncol = 2, scales = "free_x")
```

### Sentiment Analysis with AFINN by Category
```{r}
AnimalTales_sentiment_afinn <- AnimalTales %>%
  unnest_tokens(word, text) %>%
  inner_join(get_sentiments("afinn"))%>%
  group_by(story, index=linenumber%/%5)%>%
  summarise(sentiment = sum(score))

AnimalTales_sentiment_afinn %>%
  ggplot(aes(index, sentiment, fill=story))+
  geom_col(show.legend = FALSE)+
  facet_wrap(~story, ncol = 2, scales = "free_x")
```

```{r}
TalesOfMagic_sentiment_afinn <- TalesOfMagic %>%
  unnest_tokens(word, text) %>%
  inner_join(get_sentiments("afinn"))%>%
  group_by(story, index=linenumber%/%5)%>%
  summarise(sentiment = sum(score))

TalesOfMagic_sentiment_afinn %>%
  ggplot(aes(index, sentiment, fill=story))+
  geom_col(show.legend = FALSE)+
  facet_wrap(~story, ncol = 2, scales = "free_x")
```

```{r}
RealisticTales_sentiment_afinn <- RealisticTales %>%
  unnest_tokens(word, text) %>%
  inner_join(get_sentiments("afinn"))%>%
  group_by(story, index=linenumber%/%5)%>%
  summarise(sentiment = sum(score))

RealisticTales_sentiment_afinn %>%
  ggplot(aes(index, sentiment, fill=story))+
  geom_col(show.legend = FALSE)+
  facet_wrap(~story, ncol = 2, scales = "free_x")
```


```{r}
AnecdotesAndJokes_sentiment_afinn <- AnecdotesAndJokes %>%
  unnest_tokens(word, text) %>%
  inner_join(get_sentiments("afinn"))%>%
  group_by(story, index=linenumber%/%5)%>%
  summarise(sentiment = sum(score))

AnecdotesAndJokes_sentiment_afinn %>%
  ggplot(aes(index, sentiment, fill=story))+
  geom_col(show.legend = FALSE)+
  facet_wrap(~story, ncol = 2, scales = "free_x")
```

```{r}
FormulaTales_sentiment_afinn <- FormulaTales %>%
  unnest_tokens(word, text) %>%
  inner_join(get_sentiments("afinn"))%>%
  group_by(story, index=linenumber%/%5)%>%
  summarise(sentiment = sum(score))

FormulaTales_sentiment_afinn %>%
  ggplot(aes(index, sentiment, fill=story))+
  geom_col(show.legend = FALSE)+
  facet_wrap(~story, ncol = 2, scales = "free_x")
```

```{r}
NoCategoryTales_sentiment_afinn <- NoCategoryTales %>%
  unnest_tokens(word, text) %>%
  inner_join(get_sentiments("afinn"))%>%
  group_by(story, index=linenumber%/%5)%>%
  summarise(sentiment = sum(score))

NoCategoryTales_sentiment_afinn %>%
  ggplot(aes(index, sentiment, fill=story))+
  geom_col(show.legend = FALSE)+
  facet_wrap(~story, ncol = 2, scales = "free_x")
```
### Sentiment Analysis with NRC by Category
```{r}
AnimalTales_sentiment_nrc <- AnimalTales %>%
  unnest_tokens(word, text) %>%
  inner_join(get_sentiments("nrc"))%>%
  group_by(story)%>%
  count(sentiment)%>%
  ungroup()%>%
  mutate(sentiment = reorder(sentiment, n))

AnimalTales_sentiment_nrc%>%
  ggplot(aes(sentiment, n, fill=story))+
  geom_col(show.legend = FALSE)+
  facet_wrap(~story, ncol = 2, scales = "free")+
  coord_flip()
```

```{r}
TalesOfMagic_sentiment_nrc <- TalesOfMagic %>%
  unnest_tokens(word, text) %>%
  inner_join(get_sentiments("nrc"))%>%
  group_by(story)%>%
  count(sentiment)%>%
  ungroup()%>%
  mutate(sentiment = reorder(sentiment, n))

TalesOfMagic_sentiment_nrc%>%
  ggplot(aes(sentiment, n, fill=story))+
  geom_col(show.legend = FALSE)+
  facet_wrap(~story, ncol = 2, scales = "free")+
  coord_flip()
```

```{r}
RealisticTales_sentiment_nrc <- RealisticTales %>%
  unnest_tokens(word, text) %>%
  inner_join(get_sentiments("nrc"))%>%
  group_by(story)%>%
  count(sentiment)%>%
  ungroup()%>%
  mutate(sentiment = reorder(sentiment, n))

RealisticTales_sentiment_nrc%>%
  ggplot(aes(sentiment, n, fill=story))+
  geom_col(show.legend = FALSE)+
  facet_wrap(~story, ncol = 2, scales = "free")+
  coord_flip()
```

```{r}
AnecdotesAndJokes_sentiment_nrc <- AnecdotesAndJokes %>%
  unnest_tokens(word, text) %>%
  inner_join(get_sentiments("nrc"))%>%
  group_by(story)%>%
  count(sentiment)%>%
  ungroup()%>%
  mutate(sentiment = reorder(sentiment, n))

AnecdotesAndJokes_sentiment_nrc%>%
  ggplot(aes(sentiment, n, fill=story))+
  geom_col(show.legend = FALSE)+
  facet_wrap(~story, ncol = 2, scales = "free")+
  coord_flip()
```

```{r}
FormulaTales_sentiment_nrc <- FormulaTales %>%
  unnest_tokens(word, text) %>%
  inner_join(get_sentiments("nrc"))%>%
  group_by(story)%>%
  count(sentiment)%>%
  ungroup()%>%
  mutate(sentiment = reorder(sentiment, n))

FormulaTales_sentiment_nrc%>%
  ggplot(aes(sentiment, n, fill=story))+
  geom_col(show.legend = FALSE)+
  facet_wrap(~story, ncol = 2, scales = "free")+
  coord_flip()
```

```{r}
NoCategoryTales_sentiment_nrc <- NoCategoryTales %>%
  unnest_tokens(word, text) %>%
  inner_join(get_sentiments("nrc"))%>%
  group_by(story)%>%
  count(sentiment)%>%
  ungroup()%>%
  mutate(sentiment = reorder(sentiment, n))

NoCategoryTales_sentiment_nrc%>%
  ggplot(aes(sentiment, n, fill=story))+
  geom_col(show.legend = FALSE)+
  facet_wrap(~story, ncol = 2, scales = "free")+
  coord_flip()
```



